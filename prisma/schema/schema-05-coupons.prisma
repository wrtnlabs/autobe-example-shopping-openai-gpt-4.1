/// Main business entity for all available discount/coupon definitions.
/// Represents the logical configuration of a coupon: code, type, discount
/// metadata, validity window, applicability (all/segment),
/// stackability/exclusivity, issuance/usage caps, and auditability.
/// Independently managed by admins or sellers. Referenced by issuances,
/// targets, usages, and campaigns. Snapshotted on all configuration or
/// status changes.
///
/// @namespace Coupons
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupons {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Associated campaign's {@link shopping_mall_coupon_campaigns.id}. Nullable
  /// if stand-alone or ad hoc coupon.
  shopping_mall_coupon_campaign_id String?
  
  /// Unique coupon code or template (for single/bulk issuance).
  code String
  
  /// Coupon title/label, user-facing.
  title String
  
  /// Coupon description (terms, usage, etc).
  description String?
  
  /// Type of coupon (public, private, one-time, etc).
  coupon_type String
  
  /// Discount logic: 'amount', 'percentage', 'free_shipping', etc.
  discount_type String
  
  /// Discount value (amount/percentage depending on discount_type).
  discount_value Float
  
  /// Minimum eligible order amount for coupon use.
  min_order_amount Float?
  
  /// Maximum discount (for capped percentage types).
  max_discount_amount Float?
  
  /// Whether coupon can be stacked with others.
  stackable Boolean
  
  /// If true, coupon is exclusive (cannot be combined).
  exclusive Boolean
  
  /// Total usage cap for this coupon.
  usage_limit_total Int?
  
  /// Per-user usage cap for this coupon.
  usage_limit_per_user Int?
  
  /// Total issuances allowed for this coupon.
  issuance_limit_total Int?
  
  /// Running total of times coupon issued.
  issued_count Int
  
  /// Running total of times coupon used.
  used_count Int
  
  /// Coupon activation/start time.
  issued_at DateTime?
  
  /// Coupon expiration/end time.
  expires_at DateTime?
  
  /// Business/lifecycle status (e.g., draft, active, paused, expired, deleted).
  business_status String
  
  /// Coupon creation timestamp.
  created_at DateTime
  
  /// Coupon last update timestamp.
  updated_at DateTime
  
  /// Logical deletion timestamp.
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  campaign shopping_mall_coupon_campaigns? @relation(fields: [shopping_mall_coupon_campaign_id], references: [id], onDelete: Cascade)
  
  shopping_mall_coupon_issuances shopping_mall_coupon_issuances[]
  shopping_mall_coupon_usages shopping_mall_coupon_usages[]
  shopping_mall_coupon_targets shopping_mall_coupon_targets[]
  shopping_mall_coupon_snapshots shopping_mall_coupon_snapshots[]
  shopping_mall_coupon_analytics shopping_mall_coupon_analytics?
  
  @@index([shopping_mall_coupon_campaign_id])
  
  @@unique([code])
  @@index([business_status])
  @@index([expires_at])
}

/// Records actual issuances (allocation or assignment) of coupons to actors
/// (customers, accounts, segments, etc). Each record tracks the actor being
/// granted the coupon, when/for which coupon, issuance status, and context.
/// Used to enforce per-user/segment limits. May be generated in bulk or 1:1
/// (e.g., single-use). References coupon and optionally customer.
///
/// @namespace Coupons
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupon_issuances {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Referenced coupon's {@link shopping_mall_coupons.id}.
  shopping_mall_coupon_id String
  
  /// Recipient actor's {@link shopping_mall_customers.id}. Nullable for
  /// public/anonymous cases.
  shopping_mall_customer_id String?
  
  /// Actual coupon code issued (could be unique per issuance).
  code String
  
  /// Time issued.
  issued_at DateTime
  
  /// Expiration for this issuance (may differ from base coupon).
  expires_at DateTime?
  
  /// Usage limit for this actor (may override per-user global).
  usage_limit Int?
  
  /// Number of times actor has used this issued coupon.
  used_count Int
  
  /// Issuance status (active, expired, redeemed, revoked, etc).
  status String
  
  /// Creation timestamp.
  created_at DateTime
  
  /// Update timestamp.
  updated_at DateTime
  
  /// Deletion timestamp (for soft delete, audit).
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  coupon shopping_mall_coupons @relation(fields: [shopping_mall_coupon_id], references: [id], onDelete: Cascade)
  customer shopping_mall_customers? @relation(fields: [shopping_mall_customer_id], references: [id], onDelete: Cascade)
  
  shopping_mall_coupon_usages shopping_mall_coupon_usages[]
  
  @@index([shopping_mall_customer_id])
  
  @@unique([code])
  @@index([shopping_mall_coupon_id, shopping_mall_customer_id], map: "shopping_mall_coupon_issuances_shopping_mall_coupon_id_f18ca7f6")
}

/// Tracks individual coupon usage events. Each record logs coupon and
/// issuance, order context, acting customer, timestamps, and outcome. Used
/// for full audit/analytics, fraud/abuse monitoring, and per-user limit
/// enforcement. Key for analytics, auditing, and operational business rules.
///
/// @namespace Coupons
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupon_usages {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Used coupon's {@link shopping_mall_coupons.id}.
  shopping_mall_coupon_id String
  
  /// Link to exact issuance used {@link shopping_mall_coupon_issuances.id}.
  shopping_mall_coupon_issuance_id String
  
  /// Order where coupon was used {@link shopping_mall_orders.id}.
  shopping_mall_order_id String
  
  /// Customer using the coupon {@link shopping_mall_customers.id}.
  shopping_mall_customer_id String
  
  /// Usage timestamp.
  used_at DateTime
  
  /// Usage status: 'applied', 'confirmed', 'revoked', 'failed', etc.
  status String
  
  /// Actual discount value applied in use event.
  discount_amount Float
  
  /// Record creation timestamp.
  created_at DateTime
  
  /// Update timestamp.
  updated_at DateTime
  
  //----
  // RELATIONS
  //----
  coupon shopping_mall_coupons @relation(fields: [shopping_mall_coupon_id], references: [id], onDelete: Cascade)
  issuance shopping_mall_coupon_issuances @relation(fields: [shopping_mall_coupon_issuance_id], references: [id], onDelete: Cascade)
  order shopping_mall_orders @relation(fields: [shopping_mall_order_id], references: [id], onDelete: Cascade)
  customer shopping_mall_customers @relation(fields: [shopping_mall_customer_id], references: [id], onDelete: Cascade)
  
  @@index([shopping_mall_coupon_issuance_id], map: "shopping_mall_coupon_usages_shopping_mall_coupon_issua_4a7da6c0")
  @@index([shopping_mall_order_id])
  @@index([shopping_mall_customer_id])
  
  @@index([shopping_mall_coupon_id, shopping_mall_customer_id, used_at], map: "shopping_mall_coupon_usages_shopping_mall_coupon_id_sh_53c1b2d0")
}

/// Subsidiary table that defines which entities (channels, sections,
/// categories, sellers, products, customers, etc.) a coupon is eligible to
/// be applied to. Many-to-many mapping supports broad and fine-grained
/// targeting. Not directly exposed to business users, but referenced by
/// coupons and used in eligibility validation. Enables efficient eligibility
/// queries and administration of coupon scope.
///
/// @namespace Coupons
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupon_targets {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Parent coupon {@link shopping_mall_coupons.id}.
  shopping_mall_coupon_id String
  
  /// Linked channel {@link shopping_mall_channels.id}. Nullable if not scoped.
  shopping_mall_channel_id String?
  
  /// Linked section {@link shopping_mall_sections.id}. Nullable if not scoped.
  shopping_mall_section_id String?
  
  /// Linked category {@link shopping_mall_channel_categories.id}. Nullable for
  /// global coupons.
  shopping_mall_channel_category_id String?
  
  /// Targeted product eligibility {@link shopping_mall_products.id}. Nullable
  /// for broader coupons.
  shopping_mall_product_id String?
  
  /// Eligible seller {@link shopping_mall_sellers.id}. Nullable for broader
  /// coupons.
  shopping_mall_seller_id String?
  
  /// Eligible customer {@link shopping_mall_customers.id}. Nullable for
  /// segment or global coupons.
  shopping_mall_customer_id String?
  
  /// Indicates what this row maps to - e.g., 'channel', 'section', 'category',
  /// 'product', 'seller', 'customer'.
  target_type String
  
  /// Creation timestamp.
  created_at DateTime
  
  //----
  // RELATIONS
  //----
  coupon shopping_mall_coupons @relation(fields: [shopping_mall_coupon_id], references: [id], onDelete: Cascade)
  channel shopping_mall_channels? @relation(fields: [shopping_mall_channel_id], references: [id], onDelete: Cascade)
  section shopping_mall_sections? @relation(fields: [shopping_mall_section_id], references: [id], onDelete: Cascade)
  category shopping_mall_channel_categories? @relation(fields: [shopping_mall_channel_category_id], references: [id], onDelete: Cascade)
  product shopping_mall_products? @relation(fields: [shopping_mall_product_id], references: [id], onDelete: Cascade)
  seller shopping_mall_sellers? @relation(fields: [shopping_mall_seller_id], references: [id], onDelete: Cascade)
  customer shopping_mall_customers? @relation(fields: [shopping_mall_customer_id], references: [id], onDelete: Cascade)
  
  @@index([shopping_mall_channel_id])
  @@index([shopping_mall_section_id])
  @@index([shopping_mall_channel_category_id], map: "shopping_mall_coupon_targets_shopping_mall_channel_cat_7684e0ad")
  @@index([shopping_mall_product_id])
  @@index([shopping_mall_seller_id])
  @@index([shopping_mall_customer_id])
  
  @@index([shopping_mall_coupon_id, target_type], map: "shopping_mall_coupon_targets_shopping_mall_coupon_id_t_034494ec")
}

/// Represents an organized campaign grouping one or more coupons under a
/// business concept—promo, seasonal event, collaboration, etc. Stores
/// campaign metadata: name, description, period, business status, and
/// categorical analytics. Coupons may be standalone or linked to a campaign.
/// Campaigns are independently managed via business UI.
///
/// @namespace Coupons
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupon_campaigns {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Business-facing campaign name.
  name String
  
  /// Campaign description and terms.
  description String?
  
  /// Campaign activation/start time.
  starts_at DateTime?
  
  /// Campaign end/expiration time.
  ends_at DateTime?
  
  /// Workflow status: draft, active, paused, expired, deleted, etc.
  business_status String
  
  /// Campaign creation timestamp.
  created_at DateTime
  
  /// Campaign update timestamp.
  updated_at DateTime
  
  /// Logical deletion timestamp, for partitioning and audit.
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  shopping_mall_coupons shopping_mall_coupons[]
  shopping_mall_coupon_analytics shopping_mall_coupon_analytics[]
  
  @@unique([name])
  @@index([business_status])
  @@index([starts_at])
  @@index([ends_at])
}

/// Snapshot/history table supporting full point-in-time audit of coupon
/// definitions and all linked configuration and eligibility at every event.
/// Historical/log-audit for every change or status/event affecting main
/// coupon configuration. Used for forensic, rollback, and compliance
/// requests. Not user-editable, append-only, records all pre- and
/// post-change coupon details.
///
/// @namespace Coupons
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupon_snapshots {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Target coupon {@link shopping_mall_coupons.id}.
  shopping_mall_coupon_id String
  
  /// Type of snapshot event: creation, update, status_change, etc.
  snapshot_type String
  
  /// JSON or serialized snapshot data for the coupon and all linked
  /// configuration.
  snapshot_data String
  
  /// Snapshot creation time.
  snapshot_at DateTime
  
  //----
  // RELATIONS
  //----
  coupon shopping_mall_coupons @relation(fields: [shopping_mall_coupon_id], references: [id], onDelete: Cascade)
  
  @@index([shopping_mall_coupon_id, snapshot_at], map: "shopping_mall_coupon_snapshots_shopping_mall_coupon_id_be5e5c06")
}

/// Materialized view or reporting table for coupons: stores denormalized or
/// pre-aggregated coupon campaign/issuance/usage statistics, trends, and
/// business intelligence metrics. NOT a business object for direct CRUD, but
/// critical for dashboard/query performance. Updated by scheduled/batch jobs
/// only. Examples include coupon utilization rate, issuance-to-redemption
/// ratio, per-segment analytics, etc.
///
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model shopping_mall_coupon_analytics {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Source coupon {@link shopping_mall_coupons.id}.
  shopping_mall_coupon_id String
  
  /// Linked campaign (if any) {@link shopping_mall_coupon_campaigns.id}.
  shopping_mall_coupon_campaign_id String?
  
  /// Total issued (prefetched/denormalized for analytics).
  stat_issued_count Int
  
  /// Total used (prefetched/denormalized for analytics).
  stat_used_count Int
  
  /// Redemption/usage rate (percent of issued redeemed).
  stat_usage_rate Float
  
  /// Timestamp of most recent use event.
  stat_last_used_at DateTime?
  
  /// Timestamp of most recent issuance event.
  stat_last_issued_at DateTime?
  
  /// JSON: analytics per segment/target group.
  stat_segment_analytics String?
  
  //----
  // RELATIONS
  //----
  coupon shopping_mall_coupons @relation(fields: [shopping_mall_coupon_id], references: [id], onDelete: Cascade)
  campaign shopping_mall_coupon_campaigns? @relation(fields: [shopping_mall_coupon_campaign_id], references: [id], onDelete: Cascade)
  
  @@index([shopping_mall_coupon_campaign_id], map: "shopping_mall_coupon_analytics_shopping_mall_coupon_ca_2a942e2c")
  
  @@unique([shopping_mall_coupon_id])
  @@index([stat_usage_rate])
}