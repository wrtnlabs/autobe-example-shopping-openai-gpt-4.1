import { Controller } from "@nestjs/common";
import { TypedRoute, TypedParam, TypedBody } from "@nestia/core";
import typia, { tags } from "typia";
import { postaiCommerceBuyerOrdersOrderIdRefunds } from "../../../../../providers/postaiCommerceBuyerOrdersOrderIdRefunds";
import { BuyerAuth } from "../../../../../decorators/BuyerAuth";
import { BuyerPayload } from "../../../../../decorators/payload/BuyerPayload";
import { patchaiCommerceBuyerOrdersOrderIdRefunds } from "../../../../../providers/patchaiCommerceBuyerOrdersOrderIdRefunds";
import { getaiCommerceBuyerOrdersOrderIdRefundsRefundId } from "../../../../../providers/getaiCommerceBuyerOrdersOrderIdRefundsRefundId";

import { IAiCommerceOrderRefund } from "../../../../../api/structures/IAiCommerceOrderRefund";
import { IPageIAiCommerceOrderRefund } from "../../../../../api/structures/IPageIAiCommerceOrderRefund";

@Controller("/aiCommerce/buyer/orders/:orderId/refunds")
export class AicommerceBuyerOrdersRefundsController {
  /**
   * Create a refund record for a specific order in ai_commerce_order_refunds.
   *
   * Create a new refund record associated with an order by providing the
   * necessary data in the request body, as defined by the
   * IAiCommerceOrderRefund.ICreate schema. This operation appends a new row to
   * ai_commerce_order_refunds, linking it to orderId and setting initial
   * statuses and amounts per the submitted refund request data. This API is a
   * critical part of customer support and after-sales flows.
   *
   * Role-specific business logic is enforced: only the buyer who placed the
   * order, a seller for products related to the order (where permitted by
   * policy/business logic), or an admin can create a refund. Refund
   * eligibility, requested amount, status, and reason are validated against the
   * order/payment status. Compliance logic may block or require further
   * escalation for orders that are not eligible for refund or are already fully
   * refunded. The system creates required audit logs, both for the creation
   * action and for compliance tracking of all refund activity.
   *
   * Errors resulting from invalid orderId, bad input, or ineligible status
   * result in explicit business error codes, and all failed creation attempts
   * are logged. The created refund is returned in the response on success.
   *
   * @param connection
   * @param orderId Unique identifier of the order to which the refund is
   *   attached. Must be a UUID string referencing ai_commerce_orders.id.
   * @param body New refund request data for the order, matching
   *   IAiCommerceOrderRefund.ICreate schema.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Post()
  public async create(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IAiCommerceOrderRefund.ICreate,
  ): Promise<IAiCommerceOrderRefund> {
    try {
      return await postaiCommerceBuyerOrdersOrderIdRefunds({
        buyer,
        orderId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * List all refunds for a specific order with search and pagination from
   * ai_commerce_order_refunds.
   *
   * Retrieve a filtered, paginated list of order refunds using advanced search,
   * filter, and sort capabilities. The operation uses orderId as the primary
   * path parameter and leverages POST body parameters for complex querying,
   * corresponding directly to ai_commerce_order_refunds attributes such as
   * refund_code, reason, status, and amount.
   *
   * This endpoint is critical for customer support, compliance review, and
   * financial operations, as it enables authorized users to review historic,
   * active, and pending refunds in detail. Security controls ensure that only
   * users with an appropriate business relationship to the order—the buyer,
   * seller, or relevant admin—can access refund history for the order. Business
   * logic supports result pagination, complex search criteria, and customizable
   * sort orders.
   *
   * The operation integrates with backend business logic to ensure that only
   * refunds actually belonging to the given order are returned, and that
   * sensitive financial metadata is appropriately masked or filtered according
   * to user authorization. Errors for invalid order IDs or unauthorized access
   * are handled gracefully, with explicit error messages and audit logging of
   * all result requests.
   *
   * @param connection
   * @param orderId Unique identifier of the target order. Must be a UUID string
   *   referencing ai_commerce_orders.id.
   * @param body Search and filter parameters for refund list retrieval,
   *   matching IAiCommerceOrderRefund.IRequest schema.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IAiCommerceOrderRefund.IRequest,
  ): Promise<IPageIAiCommerceOrderRefund> {
    try {
      return await patchaiCommerceBuyerOrdersOrderIdRefunds({
        buyer,
        orderId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Get detailed information for a specific refund associated with an order
   * from ai_commerce_order_refunds.
   *
   * Retrieve full detail of a specific order refund record by orderId and
   * refundId. The operation corresponds directly to ai_commerce_order_refunds
   * and is used by customer support, buyers, sellers, and compliance
   * administrators to view refund status, amount, currency, request/resolve
   * timestamps, actor, and business notes.
   *
   * Security logic ensures only stakeholders authorized by business rules can
   * access the refund: this includes the buyer involved in the order, the
   * seller responsible for the product, and platform administrators. The API
   * returns sensitive financial and process details according to the role of
   * the requester, masking or filtering fields if needed.
   *
   * If either the order or refund ID is not found, or access is attempted by an
   * unauthorized party, the system responds with explicit error codes and
   * explanations. Refund detail retrieval is also monitored for compliance and
   * audit logging purposes.
   *
   * @param connection
   * @param orderId Unique identifier of the order to which the refund is
   *   attached. Must be a UUID string referencing ai_commerce_orders.id.
   * @param refundId Unique identifier of the target refund record. Must be a
   *   UUID string referencing ai_commerce_order_refunds.id.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":refundId")
  public async at(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedParam("refundId")
    refundId: string & tags.Format<"uuid">,
  ): Promise<IAiCommerceOrderRefund> {
    try {
      return await getaiCommerceBuyerOrdersOrderIdRefundsRefundId({
        buyer,
        orderId,
        refundId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
