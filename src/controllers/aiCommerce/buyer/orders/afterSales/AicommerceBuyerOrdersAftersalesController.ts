import { Controller } from "@nestjs/common";
import { TypedRoute, TypedParam, TypedBody } from "@nestia/core";
import typia, { tags } from "typia";
import { postaiCommerceBuyerOrdersOrderIdAfterSales } from "../../../../../providers/postaiCommerceBuyerOrdersOrderIdAfterSales";
import { BuyerAuth } from "../../../../../decorators/BuyerAuth";
import { BuyerPayload } from "../../../../../decorators/payload/BuyerPayload";
import { patchaiCommerceBuyerOrdersOrderIdAfterSales } from "../../../../../providers/patchaiCommerceBuyerOrdersOrderIdAfterSales";
import { getaiCommerceBuyerOrdersOrderIdAfterSalesAfterSalesId } from "../../../../../providers/getaiCommerceBuyerOrdersOrderIdAfterSalesAfterSalesId";
import { putaiCommerceBuyerOrdersOrderIdAfterSalesAfterSalesId } from "../../../../../providers/putaiCommerceBuyerOrdersOrderIdAfterSalesAfterSalesId";

import { IAiCommerceOrderAfterSales } from "../../../../../api/structures/IAiCommerceOrderAfterSales";
import { IPageIAiCommerceOrderAfterSales } from "../../../../../api/structures/IPageIAiCommerceOrderAfterSales";

@Controller("/aiCommerce/buyer/orders/:orderId/afterSales")
export class AicommerceBuyerOrdersAftersalesController {
  /**
   * Create a new after-sales case for an order (ai_commerce_order_after_sales).
   *
   * Allows an authenticated buyer (owner of the order) or the corresponding
   * seller to submit a new after-sales request for a particular order. Based on
   * the ai_commerce_order_after_sales Prisma schema, the request may cover
   * various after-sales case types, such as return, exchange, dispute, or
   * warranty claim. The input is validated to ensure the order exists and
   * belongs to the caller, that the type/status/actor/notes are correct, and
   * that business logic (e.g., eligible item or period) is satisfied.
   *
   * This operation creates a new case record linked to the order, the
   * requesting actor, and optionally an order item. Triggers audit and
   * compliance workflows as per business requirements. Permission checks
   * prevent unauthorized users from creating after-sales cases for orders they
   * are not involved with. Upon successful creation, responds with the complete
   * after-sales record as persisted.
   *
   * @param connection
   * @param orderId Unique identifier (UUID) of the order for which after-sales
   *   service is being requested.
   * @param body After-sales case creation payload as per
   *   IAiCommerceOrderAfterSales.ICreate DTO structure.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Post()
  public async create(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IAiCommerceOrderAfterSales.ICreate,
  ): Promise<IAiCommerceOrderAfterSales> {
    try {
      return await postaiCommerceBuyerOrdersOrderIdAfterSales({
        buyer,
        orderId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Search and list after-sales service events (ai_commerce_order_after_sales)
   * linked to an order.
   *
   * This operation fetches a paginated, optionally filtered list of all
   * after-sales service events for a particular order using
   * ai_commerce_order_after_sales. Buyers can monitor return/exchange requests
   * and their progression. Sellers/admins have full visibility for resolving
   * cases, providing support, and ensuring legal compliance.
   *
   * Advanced search fields allow filtering by event type (return, exchange,
   * dispute, warranty, etc.), status, actor, and creation/closing time. The
   * endpoint enables stakeholders to monitor, audit, and act on after-sales
   * events efficiently. Each response contains summary and detail for event
   * state, context note, and temporal fields, and is accessible based on
   * authorization as buyer of the order, seller involved in fulfillment, or
   * platform admin. Audit logging ensures evidence preservation for
   * compliance.
   *
   * @param connection
   * @param orderId Order ID whose after-sales events are being listed
   *   (ai_commerce_orders.id).
   * @param body Paginated and filtered search parameters for after-sales
   *   events.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IAiCommerceOrderAfterSales.IRequest,
  ): Promise<IPageIAiCommerceOrderAfterSales> {
    try {
      return await patchaiCommerceBuyerOrdersOrderIdAfterSales({
        buyer,
        orderId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Retrieve a specific after-sales case for an order
   * (ai_commerce_order_after_sales).
   *
   * This endpoint allows authorized users to retrieve the complete details of a
   * single after-sales case (e.g., return, exchange, dispute) for a specific
   * order using both the order ID and after-sales case ID. The operation
   * references the ai_commerce_order_after_sales table and returns all relevant
   * fields, such as order linkage, order item reference, actor, after-sales
   * type, case status, timestamps, and any notes provided.
   *
   * Permission checks ensure that only the order's buyer, the involved seller
   * (when applicable), or a system admin can obtain this information. The
   * operation incorporates logic to return only after-sales cases relevant to
   * the requested order, minimizing leakage of other users' data.
   *
   * Validation includes confirming existence of both the order and after-sales
   * case, as well as correct association between them. Error handling covers
   * not-found, unauthorized access, and association mismatch cases. Successful
   * responses deliver all record fields as defined in the Prisma model.
   *
   * @param connection
   * @param orderId Unique identifier (UUID) of the parent order.
   * @param afterSalesId Unique identifier (UUID) of the after-sales case.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":afterSalesId")
  public async at(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedParam("afterSalesId")
    afterSalesId: string & tags.Format<"uuid">,
  ): Promise<IAiCommerceOrderAfterSales> {
    try {
      return await getaiCommerceBuyerOrdersOrderIdAfterSalesAfterSalesId({
        buyer,
        orderId,
        afterSalesId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Update an after-sales case for an order (ai_commerce_order_after_sales).
   *
   * Permits authorized actors—such as the buyer who raised the after-sales
   * request, the responsible seller, or an admin—to submit updates to a
   * specific after-sales record. This endpoint is tied to the
   * ai_commerce_order_after_sales schema and ensures full association integrity
   * between the given order and the after-sales case.
   *
   * Fields like status, note, type, or order item reference may be updated per
   * business rules. Permission logic enforces that only permitted workflow
   * actions (by role and status) are accepted. Full audit/trace of all updates
   * is maintained for compliance. The operation returns the record with updated
   * data post-modification.
   *
   * @param connection
   * @param orderId Unique identifier (UUID) of the order containing the
   *   after-sales case.
   * @param afterSalesId Unique identifier (UUID) of the after-sales case to be
   *   updated.
   * @param body Fields to update for the after-sales case, using
   *   IAiCommerceOrderAfterSales.IUpdate DTO structure.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Put(":afterSalesId")
  public async update(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("orderId")
    orderId: string & tags.Format<"uuid">,
    @TypedParam("afterSalesId")
    afterSalesId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IAiCommerceOrderAfterSales.IUpdate,
  ): Promise<IAiCommerceOrderAfterSales> {
    try {
      return await putaiCommerceBuyerOrdersOrderIdAfterSalesAfterSalesId({
        buyer,
        orderId,
        afterSalesId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
