import { Controller } from "@nestjs/common";
import { TypedRoute, TypedBody, TypedParam } from "@nestia/core";
import typia, { tags } from "typia";
import { postaiCommerceBuyerCartSessions } from "../../../../providers/postaiCommerceBuyerCartSessions";
import { BuyerAuth } from "../../../../decorators/BuyerAuth";
import { BuyerPayload } from "../../../../decorators/payload/BuyerPayload";
import { patchaiCommerceBuyerCartSessions } from "../../../../providers/patchaiCommerceBuyerCartSessions";
import { getaiCommerceBuyerCartSessionsCartSessionId } from "../../../../providers/getaiCommerceBuyerCartSessionsCartSessionId";
import { putaiCommerceBuyerCartSessionsCartSessionId } from "../../../../providers/putaiCommerceBuyerCartSessionsCartSessionId";
import { deleteaiCommerceBuyerCartSessionsCartSessionId } from "../../../../providers/deleteaiCommerceBuyerCartSessionsCartSessionId";

import { IAiCommerceCartSession } from "../../../../api/structures/IAiCommerceCartSession";
import { IPageIAiCommerceCartSession } from "../../../../api/structures/IPageIAiCommerceCartSession";

@Controller("/aiCommerce/buyer/cartSessions")
export class AicommerceBuyerCartsessionsController {
  /**
   * Create a new cart session in ai_commerce_cart_sessions.
   *
   * Creates and persists a new cart session, tied to either an authenticated
   * buyer or as an anonymous/guest session. Populates ai_commerce_cart_sessions
   * with unique session token and links to the relevant cart. Ensures
   * session_token and cart_id adhere to uniqueness constraints. Buyers can
   * create sessions for their own cart; admins may perform this for testing or
   * recovery.
   *
   * Request provides required associations and configuration; response returns
   * persisted entity. Seller/admin non-buyer accounts should not use this
   * endpoint.
   *
   * @param connection
   * @param body Creation fields for new cart session: buyer (optional), cart
   *   reference, session token, status, expiration, timestamps.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Post()
  public async create(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedBody()
    body: IAiCommerceCartSession.ICreate,
  ): Promise<IAiCommerceCartSession> {
    try {
      return await postaiCommerceBuyerCartSessions({
        buyer,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Search and list cart session entities (ai_commerce_cart_sessions) for a
   * user.
   *
   * Authenticated buyers can list/search all their cart sessions (including
   * history, active, or expired) for cross-device or session analysis. The
   * request body (IAiCommerceCartSession.IRequest) controls
   * query/filtering/pagination. Security protocols ensure only the
   * authenticated buyer sees their own data. Business rules/compliance follow
   * schema; the response is a paginated list of IAiCommerceCartSession
   * records.
   *
   * @param connection
   * @param body Search and pagination parameters for filtering cart sessions.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedBody()
    body: IAiCommerceCartSession.IRequest,
  ): Promise<IPageIAiCommerceCartSession> {
    try {
      return await patchaiCommerceBuyerCartSessions({
        buyer,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Get cart session details by cartSessionId from ai_commerce_cart_sessions.
   *
   * This endpoint retrieves a cart session record from
   * ai_commerce_cart_sessions, as identified by cartSessionId in the path
   * parameter.
   *
   * Purpose: Enables buyers or administrators to review session state, which is
   * vital for validating device merges, troubleshooting persistent carts,
   * detecting guest-to-member transitions, and supporting compliance audits.
   *
   * Buyers may only see their sessions. Admins may view all for
   * audit/troubleshooting. Sensitive attributes (e.g., session token) only
   * returned when suitably authenticated.
   *
   * Returns all session properties (including references) as present in the
   * schema. If the record doesn't exist or access is unauthorized, a standard
   * error is returned.
   *
   * @param connection
   * @param cartSessionId Unique identifier for the cart session to retrieve, as
   *   UUID.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":cartSessionId")
  public async at(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("cartSessionId")
    cartSessionId: string & tags.Format<"uuid">,
  ): Promise<IAiCommerceCartSession> {
    try {
      return await getaiCommerceBuyerCartSessionsCartSessionId({
        buyer,
        cartSessionId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Update an existing cart session in ai_commerce_cart_sessions by
   * cartSessionId.
   *
   * Updates session fields (expiration, status, cart link, session token) for
   * session identified by cartSessionId. Only the buyer who owns the session or
   * an administrator may update. Updates must adhere to business rules and not
   * permit unauthorized user cross-session updates. All updates are audited.
   *
   * Returns updated session object on success. Validates all incoming field
   * updates and returns error if the request is invalid or not allowed.
   *
   * @param connection
   * @param cartSessionId Unique identifier for the cart session to update, as
   *   UUID.
   * @param body Fields for updating cart session: supports partial or full
   *   update. Follows IAiCommerceCartSession.IUpdate schema.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Put(":cartSessionId")
  public async update(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("cartSessionId")
    cartSessionId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IAiCommerceCartSession.IUpdate,
  ): Promise<IAiCommerceCartSession> {
    try {
      return await putaiCommerceBuyerCartSessionsCartSessionId({
        buyer,
        cartSessionId,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Soft delete (erase) a cart session by cartSessionId from
   * ai_commerce_cart_sessions.
   *
   * Marks a cart session as deleted by populating deleted_at, so the session
   * persists for logs/audit/compliance. Only the owning buyer or admin may
   * trigger this. Used on logout, account deletion, and privacy workflows.
   * Attempting to erase unauthorized sessions is denied.
   *
   * @param connection
   * @param cartSessionId Unique identifier for the cart session to erase (soft
   *   delete), as UUID.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Delete(":cartSessionId")
  public async erase(
    @BuyerAuth()
    buyer: BuyerPayload,
    @TypedParam("cartSessionId")
    cartSessionId: string & tags.Format<"uuid">,
  ): Promise<void> {
    try {
      return await deleteaiCommerceBuyerCartSessionsCartSessionId({
        buyer,
        cartSessionId,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
